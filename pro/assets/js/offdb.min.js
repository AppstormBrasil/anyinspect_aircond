var db;let dbReq=indexedDB.open("AnyInspect_dnata",3);var user_info=Utils.userData(),app_path=Utils.apiPath();function sync_download(){var t=Utils.userData();if(null==t||"null"==t);else{var e=t.id,n=t.type;function a(t,e){let n=t.transaction(["tb_events"],"readwrite");n.objectStore("tb_events").add(e),n.oncomplete=function(){},n.onerror=function(t){}}function o(t,e){let n=t.transaction(["tb_events_group"],"readwrite");n.objectStore("tb_events_group").add(e),n.oncomplete=function(){},n.onerror=function(t){}}function c(t,e){let n=t.transaction(["tb_form"],"readwrite"),a=n.objectStore("tb_form"),o={id:e.id,conteudo_formulario:e.conteudo_formulario};a.add(o),n.oncomplete=function(){},n.onerror=function(t){}}function s(t,e){let n=t.transaction(["tb_single"],"readwrite");n.objectStore("tb_single").add(e),n.oncomplete=function(){},n.onerror=function(t){}}function r(t,e){let n=t.transaction(["tb_event_result"],"readwrite");n.objectStore("tb_event_result").add(e),n.oncomplete=function(){},n.onerror=function(t){}}$$("#sync_app").show(),$$("#sync_app").html('<div style="" id="loadingDiv">Aguarde Atualizando Banco de Dados</div>'),setTimeout(function(){(async function(){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const a=await fetch(app_path+"/view/get_open_events_group_off?IdUser="+e+"&type="+n,t);return await a.json()}catch(t){}})().then(t=>{if(localData=t,localData)for(var e in localData.data)a(db,localData.data[e])})},2e3),setTimeout(function(){(async function(){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const a=await fetch(app_path+"/view/get_evento_group_off?IdUser="+e+"&type="+n,t);return await a.json()}catch(t){}})().then(t=>{if(localData=t,localData)for(var e in localData.data)o(db,localData.data[e])})},1500),setTimeout(function(){(async function(){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const a=await fetch(app_path+"/view/get_form_off?IdUser="+e+"&type="+n,t);return await a.json()}catch(t){}})().then(t=>{if(localData=t,localData)for(var e in localData.data)c(db,localData.data[e])})},1500),setTimeout(function(){(async function(){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const a=await fetch(app_path+"/view/get_eventos_single_off?IdUser="+e+"&type="+n,t);return await a.json()}catch(t){}})().then(t=>{if(localData=t,localData)for(var e in localData.data)s(db,localData.data[e])})},1500),setTimeout(function(){(async function(){const t={method:"GET",headers:{"Content-Type":"application/json"}};try{const a=await fetch(app_path+"/view/get_atividade_result_all?IdUser="+e+"&type="+n,t);return await a.json()}catch(t){}})().then(t=>{if(localData=t,localData)for(var e in localData.data)r(db,localData.data[e])})},1500),setTimeout(function(){app.toast.create({text:"Banco de dados offline criado com Sucesso!",closeTimeout:2e3,cssClass:"success_toast"}).open(),$("#sync_app").fadeOut(500,function(){$$("#sync_app").hide()})},1500)}}function clearSaveEvent(){var t=db.transaction(["tb_events"],"readwrite");return t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_events").clear().onsuccess=function(t){return"Success"},"Success"}function cleartb_events(){var t=db.transaction(["tb_events"],"readwrite");return t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_events").clear().onsuccess=function(t){},"Success"}function cleartb_events_group(){var t=db.transaction(["tb_events_group"],"readwrite");t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_events_group").clear().onsuccess=function(t){}}function cleartb_forms(){var t=db.transaction(["tb_form"],"readwrite");t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_form").clear().onsuccess=function(t){}}function cleartb_save_event(){var t=db.transaction(["tb_save_event"],"readwrite");t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_save_event").clear().onsuccess=function(t){}}function cleartb_save_event_sig(){var t=db.transaction(["tb_save_event_sig"],"readwrite");t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_save_event_sig").clear().onsuccess=function(t){}}function cleartb_single(){var t=db.transaction(["tb_single"],"readwrite");t.oncomplete=function(t){1},t.onerror=function(t){0},t.objectStore("tb_single").clear().onsuccess=function(t){}}function sync_upload(){$$("#sync_app").show(),$$("#sync_app").html('<div style="" id="loadingDiv">Aguarde Atualizando Banco de Dados</div>');var t,e=window.indexedDB.open("AnyInspect_dnata",3);e.onsuccess=function(n){t=e.result;var a=[],o=[],c=[],s=[];let r=Utils.userData().id;t.transaction("tb_save_event").objectStore("tb_save_event").openCursor().onsuccess=function(t){var e=t.target.result;e&&(a.push(e.value),e.continue())},t.transaction("tb_save_event_sig").objectStore("tb_save_event_sig").openCursor().onsuccess=function(t){var e=t.target.result;e&&(o.push(e.value),e.continue())},t.transaction("tb_single").objectStore("tb_single").openCursor().onsuccess=function(t){var e=t.target.result;e&&(c.push(e.value),e.continue())},t.transaction("tb_save_event_comment").objectStore("tb_save_event_comment").openCursor().onsuccess=function(t){var e=t.target.result;e&&(s.push(e.value),e.continue())},setTimeout(function(){fetch(app_path+"/controller/sync_data_online",{method:"POST",headers:new Headers,body:JSON.stringify({alldata:a,alldatasig:o,alldatastat:c,allcomment:s,IdUsuario:r})}).then(t=>t.json()).then(t=>{$$("#sync_app").hide();var e=t.status_txt,n=t.status;if(t.status){if("SUCCESS"==n)app.toast.create({text:e,closeTimeout:2e3,cssClass:"success_toast"}).open();cleartb_events(),cleartb_events(),cleartb_events_group(),cleartb_forms(),cleartb_save_event(),cleartb_save_event_sig(),cleartb_single(),setTimeout(function(){sync_download()},4e3)}else $("#sync_app").fadeOut(500,function(){$$("#sync_app").hide()})}).catch(t=>console.log(t))},1500)}}dbReq.onupgradeneeded=function(t){(db=t.target.result).createObjectStore("tb_events",{keyPath:"id"}),db.createObjectStore("tb_events_group",{keyPath:"id"}),db.createObjectStore("tb_form",{keyPath:"id"}),db.createObjectStore("tb_single",{keyPath:"id"}),db.createObjectStore("tb_save_event",{keyPath:"id",autoIncrement:!0}),db.createObjectStore("tb_save_event_comment",{keyPath:"id",autoIncrement:!0}),db.createObjectStore("tb_save_event_sig",{keyPath:"id",autoIncrement:!0}),db.createObjectStore("tb_event_result",{keyPath:"id"})},dbReq.onsuccess=function(t){db=t.target.result},dbReq.onerror=function(t){},window.addEventListener("DOMContentLoaded",function(){document.getElementById("status");function t(t){var e=navigator.onLine?"online":"offline";setTimeout(function(){"offline"==e?($("#status_app").show(),$("#status_app").html(e.toUpperCase()),window.localStorage.setItem("global_status",0)):($("#status_app").hide(),$("#status_app").html(e.toUpperCase()),window.localStorage.setItem("global_status",1))},300)}window.addEventListener("online",function(e){sync_upload(),t()}),window.addEventListener("offline",function(e){t()})});